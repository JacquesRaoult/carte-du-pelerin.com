<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte du P√®lerin</title>
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdn.counter.dev/script.js" data-id="435f1c20-b9e5-41ba-bcb9-531b52e12138"
        data-utcoffset="1"></script>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üó∫Ô∏è Carte du P√®lerin</h1>
                <p>D√©couvrez les points d'int√©r√™t autour de vous</p>
            </div>

            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Rechercher un lieu...">
            </div>

            <div class="filters">
                <h3>Cat√©gories</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-category="all">Tous</button>
                    <button class="filter-btn" data-category="restaurant">Reliques</button>
                    <button class="filter-btn" data-category="hotel">Site remarquable</button>
                    <button class="filter-btn" data-category="monument">Mus√©e</button>
                </div>
            </div>

            <div class="poi-list" id="poiList"></div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="stats-bar">
                <span id="poiCount">0</span> points d'int√©r√™t affich√©s
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="modal-close" id="modalClose">&times;</button>
                <span class="modal-category" id="modalCategory"></span>
            </div>
            <div class="modal-body">
                <div class="modal-description" id="modalDescription"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script>
        let map;
        let markersLayer;
        let pois = [];
        let currentCategory = 'all';
        let searchTerm = '';

        // Configuration de marked pour le markdown
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // Fonction helper pour les labels de cat√©gories
        function getCategoryLabel(category) {
            const labels = {
                'restaurant': 'Reliques',
                'hotel': 'Site remarquable',
                'monument': 'Mus√©e'
            };
            return labels[category] || category;
        }

        // Ouvrir la modal
        function openModal(poi) {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const category = document.getElementById('modalCategory');
            const description = document.getElementById('modalDescription');

            title.textContent = poi.name;
            category.textContent = getCategoryLabel(poi.category);
            category.className = `modal-category category-${poi.category}`;
            
            // Convertir le markdown en HTML
            description.innerHTML = marked.parse(poi.fullDescription || 'Aucune description disponible');

            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Emp√™cher le scroll
        }

        // Fermer la modal
        function closeModal() {
            const modal = document.getElementById('modalOverlay');
            modal.classList.remove('active');
            document.body.style.overflow = ''; // R√©activer le scroll
        }

        // √âv√©nements de fermeture
        document.getElementById('modalClose').addEventListener('click', closeModal);
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') {
                closeModal();
            }
        });

        // Fermeture avec la touche √âchap
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Initialisation de la carte
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([46.5, 2.5], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            map.attributionControl.setPrefix('');

            markersLayer = L.layerGroup().addTo(map);
        }

        // Charger les donn√©es GeoJSON
        async function loadGeoJSON() {
            try {
                const response = await fetch('https://www.carte-du-pelerin.com/api/geojson');
                const geojson = await response.json();

                pois = geojson.features.map((feature, index) => {
                    const props = feature.properties || {};

                    let category = 'monument';
                    const color = props._umap_options?.color;
                    if (color === 'FireBrick') category = 'restaurant';
                    else if (color === 'SkyBlue') category = 'hotel';
                    else if (color === 'LightYellow') category = 'monument';

                    let cleanDesc = props.description || '';
                    cleanDesc = cleanDesc.replace(/üö©|üìú|üìö|üìù|üì∑|üîó|##|\*\*|{{.*?}}|\[\[.*?\]\]/g, '');
                    cleanDesc = cleanDesc.split('\n').filter(l => l.trim()).slice(0, 3).join(' ').substring(0, 200);

                    return {
                        id: feature.id || index,
                        name: props.name || 'Sans nom',
                        description: cleanDesc,
                        fullDescription: props.description || '',
                        category: category,
                        coordinates: feature.geometry.coordinates
                    };
                });

                updatePoiList();
                updateMap();
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement du GeoJSON:', error);
                alert('Erreur de chargement des donn√©es. V√©rifiez la console.');
            }
        }

        // Mettre √† jour la carte
        function updateMap() {
            markersLayer.clearLayers();

            const filteredPois = getFilteredPois();

            filteredPois.forEach(poi => {
                const [lng, lat] = poi.coordinates;

                const marker = L.marker([lat, lng]).bindPopup(`
                    <div class="popup-title">${poi.name}</div>
                    <span class="popup-category category-${poi.category}">${getCategoryLabel(poi.category)}</span>
                    <div class="popup-description">${poi.description}</div>
                    <button onclick="openModalFromMap(${poi.id})" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Voir d√©tails</button>
                `);

                marker.on('click', () => {
                    highlightPoiInList(poi.id);
                });

                markersLayer.addLayer(marker);
            });

            if (filteredPois.length > 0) {
                const bounds = L.latLngBounds(
                    filteredPois.map(poi => [poi.coordinates[1], poi.coordinates[0]])
                );
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // Fonction globale pour ouvrir la modal depuis le popup de la carte
        window.openModalFromMap = function(poiId) {
            const poi = pois.find(p => p.id === poiId);
            if (poi) {
                openModal(poi);
            }
        };

        // Filtrer les POIs
        function getFilteredPois() {
            return pois.filter(poi => {
                const matchCategory = currentCategory === 'all' || poi.category === currentCategory;
                const matchSearch = poi.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    poi.description.toLowerCase().includes(searchTerm.toLowerCase());
                return matchCategory && matchSearch;
            });
        }

        // Mettre √† jour la liste POI
        function updatePoiList() {
            const filteredPois = getFilteredPois();

            const poiList = document.getElementById('poiList');
            poiList.innerHTML = filteredPois.map(poi => `
                <div class="poi-item" data-id="${poi.id}">
                    <h4>${poi.name}</h4>
                    <span class="poi-category category-${poi.category}">${getCategoryLabel(poi.category)}</span>
                    <p>${poi.description}</p>
                </div>
            `).join('');

            // Ajouter les √©v√©nements de clic - OUVRE LA MODAL
            document.querySelectorAll('.poi-item').forEach(item => {
                item.addEventListener('click', () => {
                    const poiId = parseInt(item.dataset.id);
                    const poi = pois.find(p => p.id === poiId);
                    if (poi) {
                        openModal(poi);
                    }
                });
            });

            updateStats(filteredPois.length);
        }

        // Mettre √† jour les stats
        function updateStats(count) {
            document.getElementById('poiCount').textContent = count;
        }

        // Mettre en surbrillance un POI dans la liste
        function highlightPoiInList(poiId) {
            document.querySelectorAll('.poi-item').forEach(item => {
                item.style.background = parseInt(item.dataset.id) === poiId ? '#e9ecef' : '#f8f9fa';
            });
        }

        // Filtres de cat√©gorie
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCategory = btn.dataset.category;
                updatePoiList();
                updateMap();
            });
        });

        // Recherche
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            updatePoiList();
            updateMap();
        });

        // Toggle menu mobile
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Initialisation
        initMap();
        loadGeoJSON();
    </script>
</body>

</html>